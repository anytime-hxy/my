!function(t,e){{var a=e("body"),s=e("#page_list"),i=e("#show_panel"),p=e("#preview_page"),o=e("#cell_preview"),l=(e("#config_panel"),e("#config_item")),c=e("#add_channel"),r=e(".iframe_loading"),d=e("#add_tips"),n=e("#save_tips"),_=e("#app_style"),h=e("#config_title"),v=e("#theme_style"),f=e(".cell_panel .cell_container"),g=e(".cover_container"),m=e(".guid_layer"),u=e("#match_style");e(".all_cpt")}t.drop=!0;var b=!0,w=!0,C=!0;t.layOut=!0,t.addCover=!0,"lego_tpl"==global&&s.scrollTop(e(".p_active").offset().top-93>74?e(".p_active").offset().top-93:0);var y={evtBind:function(){a.on("click",".add_page,#page_list .p_copy,#page_list .p_del,#page_list .p_up,.cell_body .cpt_show,#show_panel .del_btn,#pop_layer,.tip_panel,.add_ok,.tip_panel .add_cancel,.del_ok,.del_cancel,.cell_panel .preview_page,#page_list .p_switch,.cancel_step,.close_preview,.close_pop,.close_pop_iframe,.save_post,.set_app_style,.tab_head .tab_title,.whole_cpt .switch_off,.whole_cpt .switch_on,.whole_cpt .switch_edit,.config_switch_on .s_on,.config_switch_off .s_off,.whole_cpt .up_cpt,#cpt_panel .common,.close_guid_layer",y.clickHandler),a.on("blur","#edit_name",y.blurHandler).on("focus","input[type='text']",y.focusHandler).on("keyup","input[type='text']",y.keyHandler),a.on("mouseenter",".cell_body .cpt_show",y.enterHandler).on("mouseleave",".cell_body .cpt_show",y.leaveHandler),this.dragHandler(),j.dragColumn(),T(),"lego_tpl"==global&&O.renderTab(appColor),x.setAppStyle()},clickHandler:function(s){s.stopPropagation();var i=e(this),p=i.attr("class");switch(p){case"add_page":e("#pop_layer").show().find(".define_name").show();break;case"p_del":i.closest("li").attr("label","1"),e("#pop_layer").show().find(".del_req").show();break;case"p_copy":var o=i.closest("li").attr("pid");w===!0&&(w=!1,k("clone_page",o));break;case"p_up":x.pageUp(i);break;case"p_switch":x.pageSwitch(i);break;case"del_btn":var c=i.closest(".cpt_show"),n=c.attr("cptid"),v=c.attr("plugid"),f=c.attr("name");k("del_cpt",n,f,c);break;case"pop_help_layer":case"close_pop":case"add_cancel":case"del_cancel":e("#page_name").val(""),d.text("不超过6个字").removeClass("w_tips"),e("#pop_layer,.tip_panel>div").hide(),e('#page_list>li[label="1"]').removeAttr("label"),b||(b=!0,t.parent.postMessage({action:"add_fail"},"*"));break;case"tip_panel":return;case"add_ok":var g=e("#page_name").val();if(""==g)d.addClass("w_tips").text("输入页面名称");else{if("不超过6个字"!=d.text())return;k("add_page",g)}break;case"del_ok":var o=e('#page_list>li[label="1"]').attr("pid");if("cover"!=o)k("del_page",o);else{var u=e("#cover_cpt .switch_on").prev(".cpt_node").attr("cptid");k("update_global_state",u,"disable",!1)}break;case"save_post":t.parent.postMessage({action:"submit_post"},"*");break;case"preview_page":a.css("overflow","hidden");var o=e("#page_list .p_active").attr("pid");"cover"==o?o=e("#page_list .p_active").next().attr("pid"):(0==e("#page_list .p_active").prev("li").length||"cover"==e("#page_list .p_active").prev("li").attr("pid"))&&(o+="&nocover=1"),r.show(),x.pagePreview(o);break;case"cancel_step":break;case"close_preview":e("#cell_preview,#preview_page").hide(),e("#qcode").children().remove(),a.css("overflow","auto");break;case"close_pop_iframe":var C=i.closest(".pop_iframe");C.find("iframe").remove(),i.closest(".pop_help_layer").hide();break;case"set_app_style":_.is(":visible")?(_.hide(),l.show(),h.html("组件管理")):(_.show(),l.hide(),h.html("风格设置"));break;case"tab_title":var I=i.closest(".tab_body"),c=i.closest(".tab_head"),j=c.find(".cur").attr("style");c.find(".cur").removeClass("cur").addClass("tab_title").removeAttr("style"),i.removeClass("tab_title").addClass("cur").attr("style",j);var O=c.next(".tab_list"),T=O.find(".tab_active"),A=O.find(".tab_none");T.removeClass("tab_active").addClass("tab_none"),A.removeClass("tab_none").addClass("tab_active"),0!=e(I).find(".tab_active iframe").length&&e(I).find(".tab_active iframe").each(function(){var t=e(this);t.attr("src",t.attr("src"))});break;case"switch_off":if(t.addCover){t.addCover=!1;var c=i.prev(".cpt_node"),f=c.attr("name"),v=c.attr("plugid");"pl5"==v&&0!=e("#cover_cpt .switch_on").length?x.pageCoverClosed(f,"add"):k("add_cpt",v,f,e(c),e("#show_panel"),"general")}else s.preventDefault();break;case"switch_on":var c=i.prev(".cpt_node"),u=c.attr("cptid"),v=c.attr("plugid"),f=c.attr("name");"pl5"==v?x.pageSwitch(e("#page_list>li[pid='cover']")):(e("#config_panel>dl").removeClass("config_switch_off").addClass("config_switch_on").attr("cptid",u).attr("plugid",v).attr("name",f),y.showConfig(u,v,f));break;case"switch_edit":case"s_on":case"s_off":var v="switch_edit"==p?i.prev(".cpt_node").attr("plugid"):i.closest("dl").attr("plugid"),u="s_on"==p||"s_off"==p?i.closest("dl").attr("cptid"):i.prev(".cpt_node").attr("cptid"),H="s_off"==p||"switch_edit"==p?"enable":"disable";if("pl5"==v&&0!=e("#cover_cpt .switch_on").length&&"switch_edit"==p){var f=i.prev(".cpt_node").attr("name");x.pageCoverClosed(f,"edit")}else k("update_global_state",u,H,!1);break;case"common":if(e("#whole_cpt,#cover_cpt").show(),e("#cpt_panel .anchor").removeClass("anchor"),i.addClass("anchor"),"cover"==i.attr("id"))var L=-736;else if("global"==i.attr("id"))var L=-368;else if("general"==i.attr("id"))var L=0;e(".cpt_box").animate({left:L},"1000");break;case"close_guid_layer":0==hasCpt&&(hasCpt=1),m.hide();break;default:if(i.hasClass("cpt_show")){var u=i.attr("cptid"),v=i.attr("plugid"),f=i.attr("name");if("pl5"==v||i.hasClass("cpt_post")){if(i.hasClass("cpt_post"))return;"pl5"!=v||e("#config_panel>dl").hasClass("config_switch_on")||e("#config_panel>dl").addClass("config_switch_on").removeClass("config_switch_off").attr("cptid",u).attr("plugid",v).attr("name",f)}else e("#config_panel>dl").removeAttr("class cptid plugid name");y.showConfig(u,v,f),e(".active").removeClass("active"),i.addClass("active")}}},showConfig:function(t,a,s){h.html("组件管理"),_.hide(),l.show().find("iframe").hide();var i=!0;if(e("#config_item>iframe").each(function(){var a=e(this);return a.attr("cptid")==t?(a.show(),void(i=!1)):void 0}),(i||0==l.find("iframe").length)&&"feedback"!=a&&"vote"!=a&&"comment"!=a&&"favor"!=a&&"column_show"!=s){var p=app_core+"?token="+token+"&control=option&cAction=display&plugId="+a+"&cptIds="+t;l.append('<iframe src="'+p+'" cptid="'+t+'"></iframe>')}},enterHandler:function(t){t.stopPropagation();var a=e(this);e("#show_panel .cpt_show:not('.active')").removeClass("cpt_border"),e("#show_panel .cpt_show .del_btn").hide(),a.addClass("cpt_border"),a.hasClass("cpt_post")?a.find(".del_btn").first().hide():a.find(".del_btn").first().show()},leaveHandler:function(t){t.stopPropagation();var a=e(this);a.removeClass("cpt_border"),a.find(".del_btn").first().hide()},dragHandler:function(){e("#core_cpt .cpt_node").draggable({connectToSortable:"#show_panel",revert:"invalid",helper:"clone",cursor:"move"}),e("#show_panel").droppable({greedy:!0,drop:function(t,a){y.dropOpt(e(a.draggable))}}),e("#show_panel").sortable({placeholder:"place_holder",axis:"y",appendTo:"#show_panel",connectWith:"#core_cpt",cancel:":input,button,.cpt_global",stop:function(){C&&I.upCptOrder()},revert:!0})},dropOpt:function(t){if(e(t).hasClass("cpt_node")&&drop){drop=!1,C=!1;var a=e(t).attr("name"),s=e(t).attr("plugid");e("#config_panel>dl").removeAttr("class cptid plugid name"),e(".active").removeClass("active"),e(t).removeClass("cpt_node cpt_drag").addClass("cpt_show").children().remove(),k("add_cpt",s,a,e(t),e("#show_panel"),"general")}},getLen:function(t){for(var e=0,a=0;a<t.length;a++)t[a].charCodeAt(0)<299?e++:e+=2;return e},blurHandler:function(){var t=e(this),a=t.closest("li"),s=a.attr("pid"),i=a.attr("old"),p=t.val(),o=y.getLen(p),l=y.getLen(i);if(o>12){var c=e(this).next("span");return c.addClass("w_tips").text("字数超过限制"),void t.removeClass("focus").addClass("wrong")}if(""==p&&l>12){var c=e(this).next("span");return c.addClass("w_tips").text("输入页面名称"),void t.removeClass("focus").addClass("wrong")}if(""==p){var c=e("#edit_name").next("span");c.addClass("w_tips").text("输入页面名称"),e("#edit_name").removeClass("focus").addClass("wrong")}else{if(a.find("span").hasClass("w_tips"))return;k("update_page_title",s,p)}},focusHandler:function(){var t=e(this);if(t.removeClass("wrong").addClass("focus"),t.next("span").hasClass("w_tips")){var a=t.next("span");a.removeClass("w_tips").text("不超过6个字")}},keyHandler:function(){var t=e(this),a=t.val(),s=y.getLen(a),i=e(this).next("span");12>=s?(i.removeClass("w_tips").text("不超过6个字"),t.addClass("focus").removeClass("wrong")):(i.addClass("w_tips").text("字数超过限制"),t.removeClass("focus").addClass("wrong"))},codeReplace:function(t){var a=e("#edit_name").closest("li");a.removeAttr("old").removeClass("p_edit").html(0==a.prev("li").length||"cover"==a.prev("li").attr("pid")?'<span class="p_title">'+t+'</span></em><em class="p_copy" title="复制页面"></em><em class="p_up" title="编辑标题"></em>':'<span class="p_title">'+t+'</span><em class="p_del" title="删除页面"></em><em class="p_copy" title="复制页面"></em><em class="p_up" title="编辑标题"></em>'),e("#page_list>li.p_label").addClass("p_active").removeClass("p_label"),e("#page_list>li:not(.p_active)").addClass("p_switch")}},k=function(a,s,i,p,o,l){var c={};switch(a){case"add_page":var r="/api/add_page";c.pageTitle=s,e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(t){0==t.stat?x.pageAdd(t.pageId,t.cptData,s,0):2==t.stat&&d.text("该名称已存在").addClass("w_tips")}});break;case"del_page":var r="/api/del_page";c.pageId=s,e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(t){0==t.stat&&x.pageDel()}});break;case"clone_page":var r="/api/clone_page";c.pageId=s,e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(t){if(0==t.stat){x.pageCopy(t.pageId,t.pageTitle,t.pageData)}}});break;case"update_page_title":var r="/api/update_page_title";c.pageId=s,c.pageTitle=i,e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(t){if(0==t.stat)y.codeReplace(i);else if(2==t.stat){var a=e("#edit_name").next("span");a.addClass("w_tips").text("该名称已存在"),e("#edit_name").removeClass("focus").addClass("wrong")}}});break;case"get_page_info":var r="/api/get_page_info";c.pageId=s,e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(t){I.pageCptRender(t.cptData,i)}});break;case"update_page_cpt_data":var r="/api/update_page_cpt_data";c.pageId=s,c.cptData=i,e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(t){0==t.stat}});break;case"update_class_cpt_data":var r="/api/update_class_cpt_data";c.classId=class_id,c.cptData=s,e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(t){0==t.stat}});break;case"add_cpt":var r="/api/add_cpt";c.plugId=s,c.cptName=i,c.pageId="pl5"==s?"cover"==e("#page_list>li:first").attr("pid")?e("#page_list>li").eq(1).attr("pid"):e("#page_list>li:first").attr("pid"):e("#page_list .p_active").attr("pid"),e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(a){if(0==a.stat){if(e(p).hasClass("cpt_node")&&(e(p).attr("cptid",a.cptId),e(p).next("button").addClass("switch_on").removeClass("switch_off").text("编辑"),e("#config_panel>dl").removeClass("config_switch_off").addClass("config_switch_on").attr("cptid",a.cptId).attr("plugid",s).attr("name",i)),t.addCover=!0,"pl5"==s&&x.pageCoverAdd(a.cptId,i),"comment"==i||"vote"==i||"feedback"==i||"favor"==i){var c=appColor;k("get_lightapp_state",c,!1,i)}I.cptAdd(e(p),a.cptId,s,i,o,l)}}});break;case"del_cpt":var r="/api/del_cpt";c.cptId=s,c.pageId="cover"!=e("#page_list .p_active").attr("pid")?e("#page_list .p_active").attr("pid"):e("#page_list .p_active").next().attr("pid"),e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(t){0==t.stat&&I.cptDel(s,i,p)}});break;case"get_cpt":var r="/api/get_cpt";c.cptId=s,e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(t){if(t[0].option){var a=t[0].option.tabList,i=e(".cpt_show[cptid='"+s+"']").find(".cur").attr("tabid"),p=e(".cpt_show[cptid='"+s+"']").find(".cur").attr("style");e(".cpt_show[cptid='"+s+"']").find(".tab_head").html('<li class="tab_title" tabid="'+a[0].tabId+'">'+a[0].name+'</li><li class="tab_title" tabid="'+a[1].tabId+'">'+a[1].name+"</li>"),e(".cpt_show[cptid='"+s+"']").find(".tab_head li[tabid='"+i+"']").addClass("cur").removeClass("tab_title").attr("style",p)}}});break;case"update_global_state":var r="/api/update_global_state",n=e(".cpt_node[cptid='"+s+"']"),_=n.attr("plugid"),h=n.attr("name");c.cptId=s,c.action=i,c.pageId="pl5"==_?"cover"==e("#page_list>li:first").attr("pid")?e("#page_list>li").eq(1).attr("pid"):e("#page_list>li:first").attr("pid"):e("#page_list .p_active").attr("pid"),e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(){if("enable"==i){e(".cpt_node[cptid='"+s+"']+button").addClass("switch_on").removeClass("switch_edit").text("编辑"),e("#config_panel>dl").removeClass("config_switch_off").addClass("config_switch_on").attr("cptid",s).attr("plugid",_).attr("name",h),"pl5"==_&&x.pageCoverAdd(s,h),y.showConfig(s,_,h);var t=e("#config_item>iframe[cptid='"+s+"']").attr("src");t.indexOf("cptOn=disable")>-1?t=t.substring(0,t.indexOf("cptOn=disable"))+"cptOn=enable":t.indexOf("cptOn=enable")>-1?t=t:t+="&cptOn=enable",e("#config_item>iframe[cptid='"+s+"']").attr("src",t)}else if(e(".cpt_node[cptid='"+s+"']+button").addClass("switch_edit").removeClass("switch_on").text("使用"),p){g.children().remove();var a=e(".cpt_node[name='"+p+"']");"add"==o?k("add_cpt",a.attr("plugid"),p,a,e("#show_panel"),"general"):k("update_global_state",a.attr("cptid"),"enable",!1)}else{var t=e("#config_item>iframe[cptid='"+s+"']").attr("src");t.indexOf("cptOn=enable")>-1?t=t.substring(0,t.indexOf("cptOn=enable"))+"cptOn=disable":t.indexOf("cptOn=disable")>-1?t=t:t+="&cptOn=disable",e("#config_panel>dl").removeClass("config_switch_on").addClass("config_switch_off"),e("#config_item>iframe[cptid='"+s+"']").attr("src",t),"pl5"==_&&x.pageCoverDel()}}});break;case"update_global_nav":var r="/api/update_global_nav";c.pageId=s,c.cptId=i,c.action=p,e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(t){0==t.stat}});break;case"update_layout_subcpt":var r="/api/update_layout_subcpt",c={cptId:s,subCpt:JSON.stringify(i)};e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(t){0==t.stat}});break;case"update_cpt_option":var r="/api/update_cpt_option",c={cptId:s,option:JSON.stringify(i)};e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(t){if(0==t.stat){var a=e("#show_panel>div.cpt_show[cptid='"+s+"']").find("iframe");a.each(function(){var t=e(this),a=t.attr("src");t.attr("src",a)})}}});break;case"update_app_option":var r="/api/update_app_option";c.option=JSON.stringify(s),e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(t){if(0==t.stat)if(i||"lego_tpl"!=global){if(appColor=s,i.indexOf("#")>-1){O.renderTab(s);var a=e(".cell_container iframe,.cover_container iframe")}else var a=e(".app_title>iframe,#show_panel .cpt_show[name='nav'] iframe");a.each(function(){var t=e(this).attr("src");e(this).attr("src",t)})}else{var o=e(".cpt_node[name='comment']").next("button").hasClass("switch_off")||e(".cpt_node[name='vote']").next("button").hasClass("switch_off")||e(".cpt_node[name='feedback']").next("button").hasClass("switch_off")||"comment"==p?"":"&showall=1",l=e(".app_title>iframe").attr("data")+o;e(".app_title>iframe").attr("src",l)}}});break;case"get_lightapp_state":var r="/api/get_lightapp_state",c={token:token};e.ajax({type:"post",url:r,data:c,dataType:"json",success:function(t){return 1==t.status?void alert("应用未找到"):(s.appid=t.appid,void k("update_app_option",s,i,p))}})}},x={pageAdd:function(t,a,i,p){e("#page_name").val(""),e("#pop_layer,.tip_panel>div").hide(),b?(f.show(),g.hide(),e("#config_panel>dl").removeAttr("class cptid plugid name"),x.getPageHtml(i,t,p,a,!1)):(b=!0,e("#config_item>iframe").each(function(){var a=e(this);if(a.is(":visible")){a.attr("id","config_iframe");var s=document.getElementById("config_iframe").contentWindow;return void s.postMessage({action:"add_success",pageTitle:i,pageId:t},"*")}}),e("#config_iframe").removeAttr("id"),s.append('<li class="p_switch" pid="'+t+'"><span class="p_title">'+i+'</span><em class="p_del" title="删除页面"></em><em class="p_copy" title="复制页面"></em><em class="p_up" title="编辑标题"></em></li>'))},pageCoverAdd:function(t,a){e(".p_active").addClass("p_switch").removeClass("p_active");var i=e("#page_list>li:first").attr("pid");if("cover"!=i){var p='<li class="p_switch" pid="cover"><span class="p_title">封面页</span><em class="p_del" title="删除页面"></em></li>';e("#page_list>li:first").before(p),m.hide()}e("#page_list>li:first").addClass("p_active").removeClass("p_switch"),s.scrollTop(0),I.cptAdjust("cover"),f.hide(),g.show().children().remove();var o=I.getCptHtml(t,"pl5");g.append('<div class="cpt_show" cptid="'+t+'" name="'+a+'" plugid="pl5"></div>'),e(".cpt_show[cptid='"+t+"']").append(o)},pageCoverClosed:function(t,a){var s=e("#cover_cpt .switch_on").prev(".cpt_node"),i=s.attr("cptid");k("update_global_state",i,"disable",t,a)},pageDel:function(){var t=e('#page_list>li[label="1"]');if(t.hasClass("p_active")){var a=e("#page_list>li:first");this.pageSwitch(a),s.scrollTop(0)}t.remove(),e("#pop_layer,.tip_panel>div").hide()},pageCoverDel:function(){{var t=g.find(".cpt_show").attr("cptid");g.find(".cpt_show").attr("name"),e(".cpt_node[cptid='"+t+"']")}e("#page_list>li[pid='cover']").remove(),e("#page_list>li:first").addClass("p_active").removeClass("p_switch"),e("#pop_layer,.tip_panel>div").hide(),x.pageSwitch(e("#page_list>li.p_active"),!0),s.scrollTop(0)},pageUp:function(t){var a=e(t).closest("li"),s=a.find(".p_title").text();a.attr("old",s),e("#page_list .p_active").addClass("p_label"),e("#page_list>li").removeClass("p_switch p_active"),a.html('<input id="edit_name" type="text" placeholder="请输入文字" value="'+s+'" /><span>不超过6个字</span><em class="p_icon"></em>').addClass("p_edit"),e("#edit_name").focus()},pageCopy:function(t,e,a){x.getPageHtml(e,t,0,a,!0)},pageSwitch:function(t,a){e(".p_active").removeClass("p_active").addClass("p_switch"),e(t).removeClass("p_switch").addClass("p_active");var s=e(t).attr("pid");if(e("#whole_cpt,#cover_cpt").show(),"cover"==s){f.hide(),g.show();var p=g.find("iframe").attr("src");g.find("iframe").attr("src",p),I.cptAdjust("cover");var o=e("#cover_cpt .switch_on").prev(".cpt_node"),l=o.attr("cptid"),c=o.attr("plugid"),r=o.attr("name");e("#config_panel>dl").addClass("config_switch_on").removeClass("config_switch_off").attr("cptid",l).attr("plugid",c).attr("name",r),m.hide(),y.showConfig(l,"pl5",r)}else i.children().remove(),g.hide(),f.show(),void 0==a&&e("#config_panel>dl").removeAttr("class cptid plugid name"),0!=e(t).find(".p_del").length||0!=e(t).prev("li").length&&"cover"!=e(t).prev("li").attr("pid")?I.cptAdjust("other"):I.cptAdjust("default",a),k("get_page_info",s,a)},pagePreview:function(t){var a=o.attr("data"),s=new Date;o.attr("src",a+t+"&ts="+s.getTime()),e("#qcode").attr("data",a+t+"&ts="+s.getTime()),e("#qcode").qrcode({text:a+t,width:150,height:150}),p.show(),o.load(function(){r.hide(),o.show()})},setAppStyle:function(){e("#app_style li").click(function(){var t=e(this),a=t.attr("data");if(a.indexOf("#")>-1){t.closest("ul").find("img").remove(),t.append('<img src="/static/home/images/selected_bg_c45996a.png" />'),e("#match_style li[data='1'] h4,#match_style li button").css("background-color",a),e("#match_style li[data='1'] div").css("color",a),e("#match_style li[data='2'] h4,#match_style li[data='2'] div").css({color:"#fff","background-color":a}),e("#match_style li[data='3'] h4,#match_style li[data='3'] div").css({"background-color":"#fff",color:a});var s=a,i=u.find(".focus").attr("data")}else{t.closest("ul").find("li").removeClass("focus"),t.addClass("focus");var s=v.find("img").closest("li").attr("data"),i=a}var p={themeColor:s,titleColor:"#fff",match:i};k("get_lightapp_state",p,a)})},getPageHtml:function(t,a,i,p,o){"cover"==e(".p_active").attr("pid")&&(g.hide(),f.show()),e(".p_active").addClass("p_switch").removeClass("p_active");var l=1==i?'<li class="p_active" pid="'+a+'"><span class="p_title">'+t+'</span><em class="p_copy" title="复制页面"></em><em class="p_up" title="编辑标题"></em></li>':'<li class="p_active" pid="'+a+'"><span class="p_title">'+t+'</span><em class="p_del" title="删除页面"></em><em class="p_copy" title="复制页面"></em><em class="p_up" title="编辑标题"></em></li>';s.append(l),I.cptAdjust("other"),o&&x.pageUp(e(".p_active"));var c=e("#page_list>li").length-1,r=37*c-1;s.scrollTop(r),I.pageCptRender(p),w=!0}},I={pageCptRender:function(t,e){i.children().remove(),0==hasCpt?m.show():(m.hide(),0!=t.length&&(t.forEach(function(t){I.cptRender(t)}),j.dragColumn())),void 0==e&&l.find("iframe").remove()},cptRender:function(t){if(void 0!=t.cptId&&"pl5"!=t.plugId){var a=t.cptId,s=t.cptName,i=t.plugId;I.getCptBlock(a,i,s);var p=e("#show_panel .cpt_show[cptid='"+a+"']");if(t.tagName&&p.addClass("cpt_post"),"lego_tpl"!=global&&p.attr("data",JSON.stringify(t)),t.option&&"column_show"==s&&0!=t.option.length){var o=t.option.column[0],l=t.option.column[1];p.find(".lay_icon").css("left",o-1),p.find(".lay_left").width(o),p.find(".lay_right").width(l)}if(t.option&&"tab_show"==s){var c=t.option.tabList[0].name,r=t.option.tabList[0].tabId,d=t.option.tabList[1].name,n=t.option.tabList[1].tabId;p.find(".tab_head>li:first").attr("tabid",r).text(c),p.find(".tab_head>li:last").attr("tabid",n).text(d),p.find(".tab_list>li:first").attr("tabid",r),p.find(".tab_list>li:last").attr("tabid",n)}if(t.option&&0!=t.option.length&&"hr"==s){t.option.margin=t.option.margin||[];var _=t.option.margin[1],h=t.option.margin[3],v=3==t.option.style||4==t.option.style?2:1,f=p.find(".hr_line>div");p.find(".hr_cpt").css({"margin-left":h+8,"margin-right":_+8}),p.find(".hr_line").removeAttr("class").addClass("hr_line hr_line_"+v),p.find(".hr_adjust").eq(0).css({left:h}),p.find(".hr_adjust").eq(1).css({left:p.width()-_-17}),f.removeAttr("class").addClass("style"+t.option.style)}t.subCpt&&0!=t.subCpt.length&&I.renderColumn(a,t,s),void 0!=t.permission&&1==t.permission&&(e('.cpt_show[cptid="'+a+'"]').find(".del_btn").first().remove(),e('.cpt_show[cptid="'+a+'"]').attr("permission","1"))}},renderColumn:function(t,a){a.subCpt.forEach(function(s){if(s.cptId){var i=e("#show_panel .cpt_show[cptid='"+t+"']"),p=i.attr("name"),o=i.find("column_show"==p?".lay_"+s.position:".tab_list>li[tabid='"+s.position+"']"),l=s.cptId,c=s.plugId,p=s.cptName,r=I.getCptHtml(l,c);e(o).append('<div class="cpt_show" cptid="'+l+'" plugid="'+c+'" name="'+p+'"><div class="del_btn"></div>'+r+"</div>"),void 0!=a.permission&&1==s.permission&&(e('.cpt_show[cptid="'+l+'"]').find(".del_btn").first().remove(),e('.cpt_show[cptid="'+l+'"]').attr("permission","1"))}})},getCptHtml:function(t,a,s){s=s||"";var i="pl1"==a&&"list"!=s?"&ext=1":"",p="favor"==s?"&pageId="+e(".p_active").attr("pid"):"",o=app_core+"?token="+token+"&control=page&plugId="+a+"&cptIds="+t+"&timestamp="+timestamp+p+"&preview=1"+i;return'<div class="cpt_body"><div class="cpt_cover"></div><iframe src="'+o+'" scrolling="no" ></iframe></div>'},getCptCode:function(t,a,s,i,p){if("pl3"!=a&&"hr"!=a)var o=this.getCptHtml(t,a,s);else if("column_show"==s)var o='<div class="lay_body"><div class="lay_icon"><span><i></i><i></i></span></div><div class="lay_con"><div class="lay_left"></div><div class="lay_right"></div></div></div>';else if("tab_show"==s)var l=O.convertColor(appColor.themeColor),o='<div class="tab_body"><ul class="tab_head" style="background-color:rgba('+l+",0.15);border-top: 1px solid rgba("+l+',0.4)"><li class="cur" style="color:'+appColor.themeColor+";border-bottom-color:"+appColor.themeColor+'" tabid="1">标题一</li><li class="tab_title" tabid="2">标题二</li></ul><ul class="tab_list" style="background-color:rgba('+l+',0.05);"><li class="tab_active" tabid="1"></li><li class="tab_none" tabid="2"></li></ul></div>';else if("hr"==s)var o='<div class="hr_body"><div class="hr_adjust hr_right"></div><div class="hr_adjust hr_left"></div><div class="hr_cpt"><div class="hr_line hr_line_1"><div class="style1"></div></div></div></div>';"ECOM"==s||"tongji"==s||"order"==s||"passengers"==s||"baseorder"==s||"scenic"==s?e(i).attr("cptid",t).addClass("cpt_global"):e(i).attr("cptid",t),"show_panel"==e(p).attr("id")?e(i).html('<div class="del_btn"></div>').append(o):(e(p).find(".lay_place_holder").remove(),e(p).append('<div class="cpt_show" cptid="'+t+'" plugid="'+a+'" name="'+s+'"><div class="del_btn"></div>'+o+"</div>"),e('#show_panel>div.cpt_show[cptid="'+t+'"]').remove())},getCptBlock:function(t,a,s){i.append('<div class="cpt_show" cptid="'+t+'" name="'+s+'" plugid="'+a+'"></div>'),I.getCptCode(t,a,s,e('#show_panel .cpt_show[cptid="'+t+'"]'),e("#show_panel"))},upCptOrder:function(){var t=[];e("#show_panel>div.cpt_show").each(function(){var a=e(this),s=a.attr("cptid"),i=a.attr("plugid"),p=a.attr("name"),o=void 0==a.attr("permission")?"":a.attr("permission");if("ECOM"!=p&&"tongji"!=p&&"order"!=p&&"passengers"!=p&&"baseorder"!=p&&"scenic"!=p){if("lego_tpl"==global||void 0==a.attr("data")){(void 0==s||null==s)&&console.log("cptid不存在");var l={};l.cptId=s,l.plugId=i,l.cptName=p,""!=o&&(l.permission=o)}else var l=JSON.parse(a.attr("data"));t.push(l)}});var a=e("#page_list .p_active").attr("pid");"lego_tpl"==global?k("update_page_cpt_data",a,JSON.stringify(t)):k("update_class_cpt_data",JSON.stringify(t))},upLayOutCpt:function(t,a){var s=e(t).attr("cptid"),i=[];"column_show"==a?e(t).find(".ui-droppable").each(function(){var t=e(this).find(".cpt_show"),a={};if(0!=t.length){a.cptId=t.attr("cptid"),a.plugId=t.attr("plugid"),a.cptName=t.attr("name");var s=void 0==t.attr("permission")?"":t.attr("permission");""!=s&&(a.permission=s)}a.position=t.parent().hasClass("lay_left")?"left":"right",i.push(a)}):0!=e(t).find(".cpt_show").length&&e(t).find(".cpt_show").each(function(){var t={},a=e(this),s=void 0==a.attr("permission")?"":a.attr("permission");t.cptId=a.attr("cptid"),t.plugId=a.attr("plugid"),t.cptName=a.attr("name"),t.position=a.closest("li").attr("tabid"),""!=s&&(t.permission=s),i.push(t)}),k("update_layout_subcpt",s,i)},cptAdd:function(t,a,s,i,p,o){if("ECOM"!=i&&"tongji"!=i&&"pl5"!=s&&"comment"!=i&&"vote"!=i&&"feedback"!=i&&"order"!=i&&"passengers"!=i&&"baseorder"!=i&&"scenic"!=i&&(I.getCptCode(a,s,i,e(t),p),C=!0,0==hasCpt&&(hasCpt=1),m.hide()),("pl3"==s||"hr"==s)&&(j.dragColumn(),drop=!0),y.showConfig(a,s,i),"general"==o){if("tongji"==i||"ECOM"==i||"pl5"==s||"comment"==i||"vote"==i||"feedback"==i||"order"==i||"passengers"==i||"baseorder"==i||"scenic"==i)return;if(I.upCptOrder(),"tab_show"==i){e("#show_panel>div.cpt_show[cptid='"+a+"']").addClass("active");var l=e('.cpt_show[cptid="'+a+'"]'),c=l.find(".tab_head>li:first").text(),r=l.find(".tab_head>li:last").text(),d=l.find(".tab_head>li:first").attr("tabid"),n=l.find(".tab_head>li:last").attr("tabid"),_=[{name:c,tabId:d},{name:r,tabId:n}],h={cptId:a,plugId:s,tabList:_};k("update_cpt_option",a,h)}}else{var l=e('.cpt_show[cptid="'+a+'"]').parent().closest(".cpt_show");I.upLayOutCpt(l,l.attr("name"))}},cptDel:function(t,a,s){var i=e(s).parent();if(e("#config_item>iframe[cptid='"+t+"']").remove(),e(s).remove(),i.hasClass("show_panel"))this.upCptOrder();else{var p=i.closest(".cpt_show").attr("name");"column_show"==p&&j.delColumn(i),I.upLayOutCpt(i.closest(".cpt_show"),p)}},cptAdjust:function(t,a){if("cover"==t&&void 0==a||a){var s=-736;a?e("#cpt_panel .common").removeClass("anchor ban"):e("#cpt_panel .common").removeClass("anchor ban").addClass("ban"),e("#cover").addClass("anchor").removeClass("ban"),e("#cover_cpt .show_tips").show()}else if("default"==t){var s=0;e("#cpt_panel .common").removeClass("anchor ban"),e("#general").addClass("anchor"),e("#core_cpt").scrollTop(0),e("#cover_cpt .show_tips").hide()}else if("other"==t){var s=0;e("#cpt_panel .common").removeClass("anchor ban"),e("#cover").addClass("ban"),e("#general").addClass("anchor"),e("#core_cpt").scrollTop(0),e("#cover_cpt .show_tips").hide()}e(".cpt_box").css("left",s)}},j={dragColumn:function(){e("#show_panel .lay_con>div,.tab_list>li").droppable({greedy:!0,tolerance:"fit",over:function(t,a){var s=e(this),i=s.closest(".cpt_show"),p=i.attr("name");if("column_show"!=p||!e(a.draggable).hasClass("cpt_show")&&0==s.find(".cpt_show").length)if(e(".place_holder").remove(),i.addClass("forbid"),"column_show"==p){if(s.closest(".lay_con").find(".lay_place_holder").remove(),0!=s.find(".cpt_show").length)return;var p=e(a.draggable).attr("name");s.append("pic"==p||"text"==p||"link"==p||"telephone"==p||"message"==p||"share"==p||"button"==p?'<div class="lay_place_holder"></div>':'<div class="lay_forbid_holder"></div>')}else s.append("tab_show"!=e(a.draggable).attr("name")&&"column_show"!=e(a.draggable).attr("name")&&"lottery"!=e(a.draggable).attr("name")&&"hr"!=e(a.draggable).attr("name")?'<div class="place_holder"></div>':'<div class="lay_forbid_holder"></div>')},out:function(){var t=e(this),a=t.closest(".cpt_show"),s=a.attr("name");a.removeClass("forbid"),"column_show"==s?t.closest("div").find(".lay_place_holder,.lay_forbid_holder").remove():t.find(".place_holder,.lay_forbid_holder").remove()},drop:function(a,s){e(".forbid").removeClass("forbid");var i=e(this),p=i.closest(".cpt_show").attr("name");if("column_show"==p&&0==i.find(".cpt_show").length){var o=e(s.draggable).attr("name");if("pic"==o||"text"==o||"link"==o||"telephone"==o||"message"==o||"share"==o||"button"==o){if(e(s.draggable).hasClass("cpt_node")&&drop){C=!1,drop=!1;var o=e(s.draggable).attr("name"),l=e(s.draggable).attr("plugid");e("#show_panel .active").removeClass("active"),e("#config_panel>dl").removeAttr("class cptid plugid name"),e(s.draggable).removeClass("cpt_node cpt_drag").addClass("cpt_show").children().remove(),k("add_cpt",l,o,e(s.draggable),e(this),"layOut")}}else t.layOut=!1,e(".lay_forbid_holder,#show_panel .cpt_node").remove()}else if("tab_show"==p){var c=e(s.draggable).attr("name");if(e(s.draggable).hasClass("cpt_node")&&drop&&"tab_show"!=c&&"column_show"!=c&&"lottery"!=c&&"hr"!=c){e(".place_holder").remove(),C=!1,drop=!1;var o=e(s.draggable).attr("name"),l=e(s.draggable).attr("plugid");e("#show_panel .active").removeClass("active"),e("#config_panel>dl").removeAttr("class cptid plugid name"),e(s.draggable).removeClass("cpt_node cpt_drag").addClass("cpt_show").children().remove(),k("add_cpt",l,o,e(s.draggable),e(this),"layOut")}else t.layOut=!1,e(".lay_forbid_holder,#show_panel .cpt_node").remove()}else y.dropOpt(e(s.draggable))}}),e(".tab_list>li").sortable({placeholder:"place_holder",axis:"y",appendTo:".tab_active",connectWith:"#core_cpt",stop:function(){var t=e(this);I.upLayOutCpt(t.closest(".cpt_show"),t.closest(".cpt_show").attr("name"))},revert:!0}),e("#show_panel .lay_icon").draggable({containment:"parent",axis:"x",drag:function(){var t=e(this),a=t.next(),s=parseInt(t.css("left")),i=a.width()-s;a.find(".lay_left").width(s),a.find(".lay_right").width(i)},stop:function(){var t=e(this),a=t.closest(".lay_body"),s=a.find(".lay_left").width(),i=a.find(".lay_right").width(),p=a.closest(".cpt_show").attr("cptid"),o=a.closest(".cpt_show").attr("plugid"),l={cptId:p,plugId:o,column:[s,i]};k("update_cpt_option",p,l)}}),e("#show_panel .hr_adjust").draggable({containment:"parent",axis:"x",drag:function(){var t=e(this),a=t.closest(".hr_body"),s=parseInt(a.find(".hr_adjust").eq(0).css("left")),i=parseInt(a.find(".hr_adjust").eq(1).css("left")),p=i>=s?i:s,o=i>=s?s:i,l=a.width()-9-p;a.find(".hr_cpt").css({"margin-left":o+8,"margin-right":l})},stop:function(){var t=e(this),a=t.closest(".hr_body").find(".hr_cpt"),s=t.closest(".hr_body").find(".hr_line"),i=parseInt(a.css("margin-right"))-8,p=parseInt(a.css("margin-left"))-8,o=s.hasClass("hr_line_1")?11:0,l=a.closest(".cpt_show").attr("cptid"),c=a.closest(".cpt_show").attr("plugid"),r=parseInt(t.closest(".hr_body").find(".hr_line>div").attr("class").substring(5)),d={cptId:l,plugId:c,margin:[o,i,o,p],style:r};k("update_cpt_option",l,d)}})},setColumn:function(t,a){if(!e(t).parent().hasClass("show_panel")){var s=0==e(t).find(".cpt_cover").length?77:e(t).find(".cpt_cover").height(),i=0==e(t).parent().siblings(".ui-droppable").find(".cpt_cover").length?77:e(t).parent().siblings(".ui-droppable").find(".cpt_cover").height(),p=s>i?s:i;
e(t).closest(".lay_con").height(a>p?a+8:p+8)}},delColumn:function(t){var a=0==e(t).find(".cpt_cover").length?85:e(t).find(".cpt_cover").height(),s=0==e(t).siblings(".ui-droppable").find(".cpt_cover").length?85:e(t).siblings(".ui-droppable").find(".cpt_cover").height(),i=a>s?a:s;e(t).closest(".lay_con").height(i>85?i+8:"auto")}},O={renderTab:function(t){e(".tab_head").each(function(){var a=e(this),s=O.convertColor(t.themeColor);a.css({"background-color":"rgba("+s+",0.15)","border-top":"1px solid rgba("+s+",0.4)"}),a.find(".cur").css({color:t.themeColor,"border-bottom-color":t.themeColor}),a.next("ul").css({"background-color":"rgba("+s+",0.05)"})})},convertColor:function(t){var e=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/,t=t.toLowerCase();if(t&&e.test(t)){if(4===t.length){for(var a="#",s=1;4>s;s+=1)a+=t.slice(s,s+1).concat(t.slice(s,s+1));t=a}for(var i=[],s=1;7>s;s+=2)i.push(parseInt("0x"+t.slice(s,s+2)));return i.join(",")}return!1}},T=function(){e(".index_panel a").click(function(a){a.preventDefault();{var s=e(this),i=s.attr("href");t.location.search,e(".p_active").attr("pid")}n.css("display","block").animate({height:42},100),setTimeout(function(){n.animate({height:0},400,function(){n.css("display","none"),t.location.href=i})},600)})};p.on("click",function(){e("#cell_preview,#preview_page").hide(),e("#qcode").children().remove(),a.css("overflow","auto")}),e(document).ready(function(){t.addEventListener("message",function(s){var i=s.data,p=i.action;switch(p){case"refresh":var o=i.cptid;if("tab_show"==e('.cpt_show[cptid="'+o+'"]').attr("name"))k("get_cpt",o);else if("hr"==e('.cpt_show[cptid="'+o+'"]').attr("name")){var r="style1"==i.style||"style2"==i.style?"hr_line_1":"hr_line_2";e('.cpt_show[cptid="'+o+'"] .hr_line').removeAttr("class").addClass("hr_line "+r),e('.cpt_show[cptid="'+o+'"] .hr_line>div').removeAttr("class").addClass(i.style)}else{var d=e('.cpt_show[cptid="'+o+'"] iframe').attr("src");e('.cpt_show[cptid="'+o+'"] iframe').attr("src",d)}if(i.field){var n=e("#page_list .p_active").attr("pid"),v="global"==i.field?"active":"inactive";k("update_global_nav",n,o,v)}break;case"add_channel":a.css("overflow","hidden");var d=i.src;c.show().find(".pop_iframe").append('<iframe src="'+d+'"></iframe>');break;case"close_add_channel":a.css("overflow","auto"),c.find("iframe").remove().end().hide();break;case"submit_channel":a.css("overflow","auto"),c.find("iframe").remove().end().hide(),e("#config_item>iframe").each(function(){var t=e(this);if(t.is(":visible")){var a=t.attr("src");return void t.attr("src",a)}});break;case"add_page":b=!1,e("#pop_layer").show().find(".define_name").show();break;case"cancel_channel":a.css("overflow","auto");var f=e(".pop_iframe").closest(".pop_help_layer");f.hide().find("iframe").remove();break;case"set_pop":{var g=i.cptid,m=i.height;i.width}e('.cpt_show[cptid="'+g+'"] iframe,.cpt_show[cptid="'+g+'"] .cpt_cover,.cpt_show[cptid="'+g+'"] .cpt_body').height(m),"column_show"==e('.cpt_show[cptid="'+g+'"]').parent().closest(".cpt_show").attr("name")&&j.setColumn(e('.cpt_show[cptid="'+g+'"]'),m),drop||(e(".active").removeClass("active"),e('.cpt_show[cptid="'+g+'"]').addClass("active"),drop=!0);break;case"mouse_up":e("body").trigger("mouseup");break;case"set_app_style":_.show(),l.hide(),h.html("风格设置");break;case"manage_post":t.location.href="lego_manage?token="+token+"&openid="+openid+"&id=channel_manage"}},!1),"lego_tpl"==global?("cover"!=pageId&&I.pageCptRender(cptData),lightapp.app.setSteps(["模板选择","模板编辑"],2)):I.pageCptRender(classCpt),y.evtBind(),"lego_tpl"==global&&(0==isFrom&&""!=pageCoverId||1==isFrom&&"cover"==pageId?(f.hide(),g.show(),m.hide(),I.cptAdjust("cover")):1==isFrom&&(0!=e("#page_list>li[pid='"+pageId+"'] .p_del").length||0==e("#page_list>li[pid='"+pageId+"'] .p_del").length&&0!=e("#page_list>li[pid='"+pageId+"']").prev("li").length&&"cover"!=e("#page_list>li[pid='"+pageId+"']").prev("li").attr("pid"))&&I.cptAdjust("default"))})}(window,$);